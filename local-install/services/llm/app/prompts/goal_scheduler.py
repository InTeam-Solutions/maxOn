from jinja2 import Template

SCHEDULE_GOAL_PROMPT_TEMPLATE = Template("""
Пользователь хочет запланировать шаги цели: "{{ goal_title }}"

Шаги цели (всего {{ steps|length }}):
{% for step in steps %}
ID: {{ step.id }}, Порядок: {{ step.order }}. {{ step.title }} (время: {{ step.estimated_hours }}ч)
{% endfor %}

Параметры планирования:
- Начальная дата: {{ start_date }}
- Deadline: {{ deadline }}
- Предпочитаемое время работы: {{ preferred_times|join(", ") if preferred_times else "любое" }}
- Предпочитаемые дни: {{ preferred_days|join(", ") if preferred_days else "любые" }}
- Длительность одной сессии: {{ duration_minutes }} минут

Существующие события пользователя (занятые слоты):
{% if existing_events %}
{% for event in existing_events %}
- {{ event.date }} в {{ event.time if event.time else "весь день" }}: {{ event.title }}
{% endfor %}
{% else %}
- Нет занятых слотов
{% endif %}

Свободные временные слоты:
{% if free_slots %}
{% for slot in free_slots[:20] %}
- {{ slot.date }} в {{ slot.time }} ({{ slot.duration_minutes }} мин)
{% endfor %}
{% if free_slots|length > 20 %}
... и еще {{ free_slots|length - 20 }} слотов
{% endif %}
{% else %}
- Нет свободных слотов найдено
{% endif %}

ВАЖНО: При планировании учитывай:
1. **Dependencies между шагами**: Шаги должны выполняться последовательно (order).
   - Шаг 2 нельзя планировать раньше Шага 1
   - Соблюдай порядок выполнения

2. **Равномерное распределение**: Распредели шаги МАКСИМАЛЬНО равномерно от start_date до deadline
   - Рассчитай общее количество часов: сумма всех estimated_hours шагов
   - Раздели это время РАВНОМЕРНО по доступным дням
   - Например: если нужно 15 часов за 7 дней с доступностью каждый день, то ~2 часа в день
   - ЗАПРЕЩЕНО планировать несколько шагов на один день, если их общее время > duration_minutes
   - Не накапливай все шаги в начале или конце
   - Оставь буфер на случай непредвиденных обстоятельств

3. **СТРОГОЕ избегание конфликтов**:
   - ОБЯЗАТЕЛЬНО используй ТОЛЬКО слоты из списка "Свободные временные слоты"
   - НИКОГДА не планируй на время существующих событий
   - Проверяй каждое событие: если planned_date совпадает с event.date И planned_time совпадает с event.time - это КОНФЛИКТ!
   - При конфликте выбери другой свободный слот

4. **Реалистичность**:
   - Если шаг требует 5 часов, а duration_minutes = 120 (2 часа), раздели шаг на 3 сессии в разные дни
   - Между сессиями одного шага должно быть минимум 1 день перерыва
   - Учитывай, что человеку нужен отдых между сессиями

5. **Приоритет свободным слотам**:
   - В первую очередь используй слоты из списка "Свободные временные слоты"
   - Они уже проверены на отсутствие конфликтов
   - Если свободных слотов недостаточно, только тогда используй другое время в preferred_times

Верни JSON массив с расписанием (используй НАСТОЯЩИЕ ID шагов из списка выше, НЕ порядковый номер):
[
  {"step_id": <ID_первого_шага>, "planned_date": "2025-11-15", "planned_time": "10:00"},
  {"step_id": <ID_второго_шага>, "planned_date": "2025-11-17", "planned_time": "14:00"},
  ...
]

Если невозможно уложиться в deadline, верни пустой массив [] и объяснение в поле "reason".
""")
